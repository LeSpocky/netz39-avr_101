%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% documentclass and packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{atbegshi}           % workaround for newer PGF versions
\documentclass{beamer}
% https://sourceforge.net/tracker/index.php?func=detail&aid=1848912&group_id=92412&atid=600660
\usepackage{lmodern}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{textcomp}
\usepackage[ngerman]{babel}
\usepackage[babel,english=american,german=guillemets]{csquotes}	% french
\usepackage{microtype}

\usepackage[european]{circuitikz}
\usepackage[locale=DE]{siunitx}
\usepackage{tikz-timing}

% colors for listings
\definecolor{lightergray}{gray}{.95}
\definecolor{darkblue}{rgb}{0,0,0.5}
\definecolor{darkgreen}{rgb}{0,0.5,0}
\definecolor{darkred}{rgb}{0.5,0,0}
\definecolor{darkerblue}{rgb}{0,0,0.4}
\definecolor{darkergreen}{rgb}{0,0.4,0}
\definecolor{darkerred}{rgb}{0.4,0,0}

\usepackage{listings}
\lstloadlanguages{C}
\lstset{
    basicstyle=\ttfamily\small\mdseries,
    keywordstyle=\bfseries\color{darkblue},
    identifierstyle=,
    commentstyle=\color{darkgray},
    stringstyle=\itshape\color{darkred},
    frame=none,
    showstringspaces=false,
    tabsize=4,
    backgroundcolor=\color{lightergray},
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% preparations for beamer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\useinnertheme{default}
\useoutertheme{infolines}
%\usecolortheme[rgb={0.28,0.37,0.52}]{structure}
\usecolortheme[rgb={0.18,0.23,0.33}]{structure}
%\usecolortheme{beaver}
\usefonttheme{structurebold}

%%% Ränder vergrößern für's Café Central
\setbeamersize{text margin left=1.2cm}
\setbeamersize{text margin right=1.2cm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% images
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pgfdeclareimage[height=0.7\paperheight]{durchlassstromgrbl}{durchlassstrom_gr-bl}
\pgfdeclareimage[height=0.7\paperheight]{durchlassstromrot}{durchlassstrom_rot}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% title, author, date
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{AVR101}
\subtitle{Kapitel 2 -- Helle LED und weniger helle LED}
\author{Netz39 e.\,V.}
\institute{\url{http://www.netz39.de/}}
\date{2014}
\subject{subj}
\keywords{AVR, Workshop, LED, PWM, ISR, Timer}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% document
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\begin{frame}
	\titlepage
\end{frame}

\begin{frame}{Überblick}
    \tableofcontents
\end{frame}

\section{LED Dimmen}

\subsection{LED Grundlagen}

\begin{frame}{LED Characteristic LRTB G6TG}
    \begin{columns}
        \begin{column}{0.5\textwidth}
            \begin{figure}
                \pgfuseimage{durchlassstromrot}
            \end{figure}
        \end{column}
        \begin{column}{0.5\textwidth}
            \begin{figure}
                \pgfuseimage{durchlassstromgrbl}
            \end{figure}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}{LED Grundschaltung}
    \begin{columns}
        \begin{column}{0.7\textwidth}
            \begin{circuitikz} \draw
                (0,0) to [ V, v<=$\SI{5}{\volt}$ ] (0,2)
                (0,2) to [ R, l=$R_V$, i>=$\SI{20}{\milli\ampere}$ ] (4,2)
                (4,2) to [ leD, v^>=$U_D$ ] (4,0)
                (4,0) to [ short ] (0,0)
                (2,0) node [ circ ] {}
                (2,0) node [ ground ] {}
                ;
            \end{circuitikz}
        \end{column}
        \pause
        \begin{column}{0.3\textwidth}
            $R_V = \frac{U_{ges} - U_D}{I}$
        \end{column}
    \end{columns}
    \pause
    \begin{itemize}
        \item LEDs werden mit konstantem Strom betrieben
        \item Vorwiderstand ist die simpelste Variante
        \item Spannung über der LED hängt von der Farbe ab
        \item hier: rot \SI{2.1}{\volt}, blau/grün \SI{3.2}{\volt}
    \end{itemize}
\end{frame}

\subsection{PWM}

\begin{frame}{PWM Grundlagen}
    \begin{block}{Timing}
        \begin{tikztimingtable}[timing/rowdist = 2.5]
            Clock       &   2{0.5C} 64{0.5C} 2{0.5C}    \\
            0\,\% on    &   L 4{8L} L                   \\
            25\,\% on   &   L 4{2H 6L} H                \\
            50\,\% on   &   L 4{4H 4L} H                \\
            87,5\,\% on &   L 4{7H 1L} H                \\
            100\,\% on  &   H 4{8H}    H                \\
        \extracode
            \begin{pgfonlayer}{background}
                \horlines[help lines]{}
                \vertlines[help lines]{ 1, 9, 17, 25, 33 }
            \end{pgfonlayer}
        \end{tikztimingtable}
    \end{block}
    \pause
    \begin{block}{Begriffe}
        \begin{itemize}
            \item Duty Cycle, Tastverhältnis
            \item Auflösung
            \item Frequenz
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{PWM mit dem AVR ATtiny85}
    \begin{block}{Peripheral Features (from datasheet)}
        \begin{quote}
            \begin{itemize}
                \item 8-bit Timer/Counter with Prescaler and Two PWM Channels
                \item 8-bit High Speed Timer/Counter with Separate Prescaler
                    \begin{itemize}
                        \item 2 High Frequency PWM Outputs with Separate Output Compare Registers
                        \item Programmable Dead Time Generator
                    \end{itemize}
            \end{itemize}
        \end{quote}
    \end{block}
    \pause
    \begin{block}{Warum nicht?}
        \begin{itemize}
            \item drei Kanäle nötig für RGB
            \item zwei verschiedene PWM-Bausteine mit je zwei Kanälen
            \item Auflösung nur 8 Bit
            \item Pins passen nicht gut auf unser Layout
            \item wir brauchen die Timer-Bausteine später noch
        \end{itemize}
    \end{block}
\end{frame}

%   TODO    Zeilennummern!
\begin{frame}[fragile]{Quick and Dirty Software PWM}
    \begin{lstlisting}[
        language=C,
        basicstyle=\ttfamily\scriptsize\mdseries,
    ]
#include <stdint.h>
#include <avr/io.h>
#define PORT_RD     (1 << PORTB3)

int main (void) {
    uint8_t pwm_count = 0, pwm_should = 0, pwm_phase = 0;
    DDRB = (1 << DDB3) | (1 << DDB1) | (1 << DDB4);

    while ( 1 ) {
        if ( pwm_should == pwm_phase ) {
            PORTB &= ~PORT_RD;
        }

        pwm_phase++;
        if ( pwm_phase == 0 ) {
            PORTB |= PORT_RD;

            pwm_count++;
            if ( pwm_count == 0 ) {
                pwm_should++;
            }
        }
    }

    return 0;
}
    \end{lstlisting}
\end{frame}

\section{Timer und Interrupts}

\subsection{Timer}

\begin{frame}{Timer Grundlagen}
    Puh, was ist denn dazu zu sagen?
\end{frame}

\begin{frame}{Soft PWM mit Timer}
    Show some registers and how we want to do it …
\end{frame}

\subsection{Interrupts und ISR}

\begin{frame}{Grundlagen Interrupts}
    What's an interrupt service routine in general?
\end{frame}

\begin{frame}{Unsere ISR für den Timer}
    Spoiler alert!
\end{frame}

\subsection{Irgendwie sieht das nicht so aus wie ich wollte}

\begin{frame}{Menschliche Wahrnehmung und Gamma-Korrektur}
    For Science!
\end{frame}

\begin{frame}{Tausche Größe gegen Geschwindigkeit}
    Lookup Table FTW!
\end{frame}

\begin{frame}{Änderungen für Nutzung des Lookup-Table}
    Show how simple it was …
\end{frame}

\subsection{Old Slides}

\begin{frame}{Pulse Width Modulation}
    \begin{itemize}
        \item on on on on off off on on on on
        \pause
        \item \emph{add nice plot here, TikZ anyone?}
        \pause
        \item not linear with perceived LED brightness
        \item don't fear pre calculated logarithmic lookup tables
    \end{itemize}
\end{frame}

\begin{frame}{Timers}
    \begin{itemize}
        \item count up or down
        \item count to a certain value
        \item count endlessly till overflow
        \item count external events
        \pause
        \item you really need the micro controller documentation!
    \end{itemize}
\end{frame}

\section{Contact}

\begin{frame}{Contact}
    \begin{center}
        \begin{description}[Twitter/identi.ca]
            \item[WWW] \url{http://www.netz39.de/}
            \item[Twitter/identi.ca] @netz39
            \item[E-Mail] kontakt@netz39.de
            \item[Mailingliste] list@netz39.de
            \item[IRC] \#netz39 on freenode
        \end{description}
    \end{center}
\end{frame}

\appendix

\section{License}

\begin{frame}{License}
    \begin{block}{Slides and Pictures}
        This work is licensed under a \emph{Creative Commons
        Attribution-ShareAlike 3.0 Unported License}, (CC-BY-SA 3.0).
        Source at: \url{https://github.com/netz39/avr_101}
    \end{block}
\end{frame}

\end{document}
